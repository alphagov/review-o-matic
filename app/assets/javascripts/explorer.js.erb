(function ($) {

	var ROOT = "http://www.direct.gov.uk";
	var HOME = "/en/index.htm";
	var REVIEWOMATIC = "<%= Plek.current.find('reviewomatic') %>";
	var MIGRATORATOR = "<%= Plek.current.find('migratorator') %>";

	var poll_interval = 1000;
	var poll_timer;
	var warned = false;

	function parse_url(url) {
		var a = document.createElement("a");
		a.href = url;
		return a;
	};

	/*
	 *  select new page for a mapping
	 */
	function select_new_url(mapping) {
		if (mapping) {
			if (mapping.new_url) {
				return mapping.new_url;
			}
			if (mapping.status == 410) {
				return MIGRATORATOR + "/browser_resources/410.html";
			}
			if (mapping.awaiting_content) {
				return MIGRATORATOR + "/browser_resources/awaiting_content.html";
			}
		}
		return MIGRATORATOR + "/browser_resources/no_mapping.html";
	}

	function load_new_url(old_url) {
		$.getJSON('/__/explore.json?old_url=' + escape(old_url), function (mapping) {
			var url = select_new_url(mapping);
			$('#new_url').val(url);
			$('#new iframe').attr('src', url);
			$('.comment form').attr('action', '/__/reviews/' + mapping.id);
		});
	}

	function load_old_url(url) {
		var src = parse_url(url).pathname || url;
		$('#old_url').val(url);
		$('#old iframe').attr('src', src);
		load_new_url(ROOT + url);
	}

	/*
	 *  check old url for change
	 */
	function check_old_url() {
		var url = $('#old iframe')[0].contentWindow.location.pathname;
		var current_url = $('#old_url').val();

		if (typeof url === 'undefined') {
			if (!warned) {
				alert("You have navigated away from Directgov, so the right hand side cannot be updated.");
			}
			$('#old_url').val('');
			$('#new_url').val('');
			warned = true;
			return;
		}

		if (url === '/blank') {
			return;
		}

		if (url === current_url) {
			return;
		}

		warned = false;

		load_old_url(url);
	}

	$(document).ready(function() {

		/*
		 *  poll for old_url to change
		 *  - onLoad of iframe slow and flaky
		 */
		poll_timer = setInterval(check_old_url, poll_interval);

		/*
		 *  load inital page
		 */
		load_old_url(HOME);

		/*
		 *  open/close comment box
		 */
		var $question = $('a.question');
		var question_text = $question.text();
		var toggle_comment = function () {
			$('.comment').slideToggle('slow');
			$question.text(
			    $question.text().match(/^Cancel/) ? question_text : 'Cancel'
			);
		};
		
		$question.click(toggle_comment);
		
		var $result = $('#result');
		$result.slideToggle(0);
		
		var show_result_briefly = function (text) {
			$result
				.text(text)
				.slideToggle();
			
			setTimeout(
				function() {
					$result.slideToggle();
				},
				3000
			);
		};
		
		/*
		 *  POST comment
		 */
		$('.comment input').click(function(event) {
			event.preventDefault();
			var $form = $(this).parent('form');
			var form_path = $form.attr('action');
			var $commentTextarea = $(this).parent().find('textarea');
			var token = $('input[name=authenticity_token]', $form).attr('value');
			$.ajax({
				type: "POST",
				url: form_path,
				data: {
					comment: $commentTextarea.val(),
					authenticity_token: token
				}, 
				success: function(data) {
					toggle_comment();
					show_result_briefly('Thank you for your help!');
    			},
				error: function(data) {
					alert("Unable to send the comments. Please try again later.");
				},
				beforeSend: function(data) {
				}
			});
		});
	});

}(jQuery));
