(function ($) {

	var ROOT = "http://www.direct.gov.uk";
	var HOME = "/en/index.htm";
	var REVIEWOMATIC = "<%= Plek.current.find('reviewomatic') %>";
	var MIGRATORATOR = "<%= Plek.current.find('migratorator') %>";

	var poll_interval = 1000;
	var poll_timer;
	var warned = false;

	function parse_url(url) {
		var a = document.createElement("a");
		a.href = url;
		return a;
	};

	/*
	 *  select new page for a mapping
	 */
	function select_new_url(mapping) {
		if (mapping) {
			if (mapping.new_url) {
				return mapping.new_url;
			}
			if (mapping.status == 410) {
				return MIGRATORATOR + "/browser_resources/410.html";
			}
			if (mapping.awaiting_content) {
				return MIGRATORATOR + "/browser_resources/awaiting_content.html";
			}
		}
		return MIGRATORATOR + "/browser_resources/no_mapping.html";
	}

	function load_new_url(old_url) {
		$.getJSON('/__/explore.json?old_url=' + escape(old_url), function (mapping) {
			var url = select_new_url(mapping);
			$('#new_url').val(url);
			$('#new iframe').attr('src', url);
		});
	}

	function load_old_url(url) {
		var src = parse_url(url).pathname || url;
		$('#old_url').val(url);
		$('#old iframe').attr('src', src);
		load_new_url(ROOT + url);
	}

	/*
	 *  check old url for change
	 */
	function check_old_url() {
		var url = $('#old iframe')[0].contentWindow.location.pathname;
		var current_url = $('#old_url').val();

		if (typeof url === 'undefined') {
			if (!warned) {
				alert("You have navigated away from Directgov, so the right hand side cannot be updated.");
			}
			$('#old_url').val('');
			$('#new_url').val('');
			warned = true;
			return;
		}

		if (url === '/blank') {
			return;
		}

		if (url === current_url) {
			return;
		}

		warned = false;

		load_old_url(url);
	}

	$(document).ready(function() {

		/*
		 *  poll for old_url to change
		 *  - onLoad of iframe slow and flaky
		 */
		poll_timer = setInterval(check_old_url, poll_interval);

		/*
		 *  load inital page
		 */
		load_old_url(HOME);

		/*
		 *  open/close comment box
		 */
		var question = $('a.question').text();
		$('a.question').click(function(event) {
			$('.comment').slideToggle('slow');
			$(this).text($(this).text().match(/^Cancel/) ? question : 'Cancel');
		});

		/*
		 *  POST comment
		 */
		$('.comment input').click(function(event) {
			event.preventDefault();
			var form_path = $(this).parent('form').attr('action');
			var $commentTextarea = $(this).parent().find('textarea');
			$.ajax({
				type: "POST",
				url: form_path,
				data: {
					comment: $commentTextarea.val()
				}, 
				success: function(data) {
					$commentTextarea.val('');
					var $commentMessage = $('<span class="success">Comment submitted</span>');
					$('.comment_messages').append($commentMessage);
					$('.form_container').fadeOut('normal', function() {
						$('.comment_messages').fadeIn('normal', function() {
						setTimeout(function() {
							$('.comment_messages').fadeOut('normal', function() {
								$('.comment_messages').empty(); 
							}); 
						}, 1000);
					  });
					});
				},
				error: function(data) {
					alert("Unable to send the comments. Please try again later.");
				},
				beforeSend: function(data) {
				}
			});
		});
	});

}(jQuery));
