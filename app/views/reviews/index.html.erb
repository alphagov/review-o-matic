<style>
  #reviews, #reviews li, dt, dd {
    margin: 0;
    padding: 0;
  }
  #reviews dd.distribution {
    border: 1px solid black;
  }
  #reviews dd.distribution span {
    display:                block;
    width:                  100%;
    background:             black;
    height:                 1em;
  }
  #reviews li {
    border: 1px solid black;
    padding: 5px;
    padding-right: 200px;
  }
  #reviews li:after {
    content: '';
    display: block;
    clear: both;
  }
  #reviews li {
    _zoom: 1; /* containing hack for IE */
  }
  .urls {
    float: left;
  }
  .urls dt {
    clear: left;
    float: left;
    padding-right: 2px;
    font-weight: bold;
    min-width: 5em;
  }
  .urls dd {
    margin: 0;
    font-family: monospace;
    font-size: 0.9em;
    padding-top: 0.2em;
    min-height: 2em;
  }
  .review-tally, .show-reviews {
    margin-right: -180px;
    float: right;
    clear: right;
    width: 180px;
  }
  .review-tally dd {
  }
  li {
    list-style:none;
  }
  .user-reviews {
    clear: both;
    margin: 0 20px;
    padding: 0;
  }
  #reviews .user-reviews li {
    border: none;
  }
</style>

<div class="container">
  <h2>Mappings in need of attention</h2>
  <ol id='reviews'>
    <% @mappings.each do |mapping| %>
      <% if @migratorator_mappings[mapping.mapping_id] %>
        <li>
          <dl class='urls'>
            <dt>Old URL</dt>
            <dd><%= @migratorator_mappings[mapping.mapping_id]['old_url'] %></dd>
            <% unless @migratorator_mappings[mapping.mapping_id]['new_url'].blank? %>
              <dt>New URL</dt>
              <dd><%= @migratorator_mappings[mapping.mapping_id]['new_url']  %></dd>
              <dt>Section</dt>
              <dd><%= mapping.section %></dd>
            <% else %>
              <% if @migratorator_mappings[mapping.mapping_id]['status'] == 410 %>
                <dt>Gone</dt>
              <% else %>
                <dt>No mapping</dt>
              <% end %>
            <% end %>
          </dl>
          <dl class='review-tally'>  
            <dt>Reviews</dt>
            <dd><%= mapping.reviews_tally[:wrong_page] %> wrong</dd>
            <dd><%= mapping.reviews_tally[:better_page] %> better</dd>
            <dd class='distribution'>
              <span style="width: <%= (mapping.reviews_tally[:wrong_page].to_f / mapping.reviews.count.to_f) * 100 %>%"></span>
            </dd>
          </dl>
          <button class='show-reviews'>Show reviews</button>
          <ul class='user-reviews'>
            <% mapping.reviews.each do |review| %>
              <li>
                <em><%= review.user.name %></em>
                <q><%= review.comment %></q>
              </li>
            <% end %>
          </ul>
        </li>
      <% end %>
    <% end %>
  </ol>
  
  
  <script>
    $('.user-reviews').hide();
    
    //show reviews
    $('.show-reviews').click(function(ev){
      var btn = ev.target;
      $('.user-reviews', $(btn).parent() ).slideToggle();
    });
  </script>
  
  <% if false %>
  <table class="review_table" border="0">
    <thead>
      <tr>
        <td>
         Position
        </td>
        <td>
          Old Url 
        </td>
        <td>
         Comments
        </td>
        <td>
          Section
        </td>
        <td>
          Edit in Migratorator
        </td>
        <td>
          Review in Review-O-Matic
        </td>
      </tr>
    </thead>
    <tbody>
    <%
      if params[:page] == nil
        count = 0
      else
        count = 0 + (params[:page].to_i - 1 ) * Kaminari.config.default_per_page
      end
    %>
    <% @mappings.each do |mapping| %>
      <tr>
        <td>
          <%= count += 1 %>
        </td>
        <td>
          <%= @migratorator_mappings[mapping.mapping_id]['old_url'] unless @migratorator_mappings[mapping.mapping_id].nil? %>          
        </td>
        <td>
          <% mapping.reviews.each do |review| %>
            <%= review.comment %>
          <% end %>
        </td>
        <td>
           <%= mapping.section %>
        </td>
        <td>
          <%= link_to "Edit", edit_migratorator_mapping_url(mapping.mapping_id),  :target => '_blank'%>
        </td>
        <td>
        </td>
      </tr>
    <% end %>

    </tbody>
  </table>
  <% end %>

  <%= paginate @mappings %>
</div>
